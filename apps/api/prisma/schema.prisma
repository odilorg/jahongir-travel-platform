// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Locale {
  en
  ru
  uz
}

enum BookingMode {
  instant
  inquiry
}

// ============================================================================
// TOURS & CATEGORIES
// ============================================================================

model Tour {
  id              String   @id @default(cuid())

  // Non-translatable fields
  price           Decimal  @db.Decimal(10, 2)
  duration        Int      // Duration in days
  maxGroupSize    Int?
  difficulty      String?  // Easy, Moderate, Challenging

  // Relations
  categoryId      String
  category        TourCategory @relation(fields: [categoryId], references: [id])

  // Media (non-translatable)
  images          String[] // Array of image URLs

  // Pricing
  showPrice       Boolean  @default(true)
  bookingMode     BookingMode @default(instant)
  discountedPrice Decimal? @db.Decimal(10, 2)

  // Status
  isActive        Boolean  @default(true)
  isFeatured      Boolean  @default(false)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  // Relations
  translations    TourTranslation[]
  itineraryItems  ItineraryItem[]
  reviews         Review[]
  inquiries       TourInquiry[]
  faqs            TourFaq[]
  bookings        Booking[]
  departures      TourDeparture[]
  pricingTiers    TourPricingTier[]

  @@index([categoryId])
  @@index([isActive])
  @@index([isFeatured])
}

model TourTranslation {
  id              String   @id @default(cuid())
  tourId          String
  tour            Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)

  locale          Locale

  // Translatable fields
  title           String
  slug            String
  summary         String?  @db.Text
  description     String?  @db.Text
  highlights      String[] // Tour highlights
  included        String[] // What's included
  excluded        String[] // What's not included

  // SEO
  metaTitle       String?
  metaDescription String?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tourId, locale])
  @@unique([locale, slug])
  @@index([locale])
  @@index([slug])
  @@index([tourId])
}

model TourCategory {
  id          String   @id @default(cuid())

  // Non-translatable fields
  image       String?
  icon        String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tours        Tour[]
  translations TourCategoryTranslation[]

  @@index([order])
}

model TourCategoryTranslation {
  id          String        @id @default(cuid())
  categoryId  String
  category    TourCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  locale      Locale

  // Translatable fields
  name        String
  slug        String
  description String?  @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([categoryId, locale])
  @@unique([locale, slug])
  @@index([locale])
  @@index([slug])
  @@index([categoryId])
}

model ItineraryItem {
  id          String   @id @default(cuid())
  tourId      String
  tour        Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)

  // Non-translatable fields
  day         Int
  meals       String[] // Breakfast, Lunch, Dinner
  accommodation String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cities       City[]   @relation("CityItineraryItem")
  translations ItineraryItemTranslation[]

  @@index([tourId])
  @@index([day])
}

model ItineraryItemTranslation {
  id          String        @id @default(cuid())
  itemId      String
  item        ItineraryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  locale      Locale

  // Translatable fields
  title       String
  description String   @db.Text
  activities  String[] // Activities for the day

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([itemId, locale])
  @@index([locale])
  @@index([itemId])
}

model TourFaq {
  id          String   @id @default(cuid())
  tourId      String
  tour        Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)

  // Non-translatable fields
  order       Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  translations TourFaqTranslation[]

  @@index([tourId])
}

model TourFaqTranslation {
  id          String   @id @default(cuid())
  faqId       String
  faq         TourFaq  @relation(fields: [faqId], references: [id], onDelete: Cascade)

  locale      Locale

  // Translatable fields
  question    String
  answer      String   @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([faqId, locale])
  @@index([locale])
  @@index([faqId])
}

// Enum for departure status
enum DepartureStatus {
  available
  filling_fast
  almost_full
  sold_out
  cancelled
}

model TourDeparture {
  id              String          @id @default(cuid())
  tourId          String
  tour            Tour            @relation(fields: [tourId], references: [id], onDelete: Cascade)

  // Departure dates
  startDate       DateTime
  endDate         DateTime

  // Availability
  maxSpots        Int
  spotsRemaining  Int
  status          DepartureStatus @default(available)

  // Pricing modifier (e.g., 1.15 for peak season, 0.9 for early bird)
  priceModifier   Decimal?        @db.Decimal(4, 2)

  // Guaranteed departure flag
  isGuaranteed    Boolean         @default(false)

  // Status
  isActive        Boolean         @default(true)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([tourId])
  @@index([startDate])
  @@index([status])
  @@index([isActive])
}

model TourPricingTier {
  id              String   @id @default(cuid())
  tourId          String
  tour            Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)

  // Guest range for this tier
  minGuests       Int
  maxGuests       Int

  // Price per person for this tier
  pricePerPerson  Decimal  @db.Decimal(10, 2)

  // Order for display
  order           Int      @default(0)

  // Status
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  translations    TourPricingTierTranslation[]

  @@index([tourId])
  @@index([order])
}

model TourPricingTierTranslation {
  id          String           @id @default(cuid())
  tierId      String
  tier        TourPricingTier  @relation(fields: [tierId], references: [id], onDelete: Cascade)

  locale      Locale

  // Translatable label (e.g., "1-2 guests", "3-5 guests", "Private Tour")
  label       String

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tierId, locale])
  @@index([locale])
  @@index([tierId])
}

// ============================================================================
// CITIES & LOCATIONS
// ============================================================================

model City {
  id          String   @id @default(cuid())

  // Non-translatable fields
  country     String   @default("Uzbekistan")

  // Geography
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)

  // Media
  image       String?
  images      String[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  translations   CityTranslation[]
  itineraryItems ItineraryItem[] @relation("CityItineraryItem")
  blogPosts      BlogPost[]
}

model CityTranslation {
  id          String   @id @default(cuid())
  cityId      String
  city        City     @relation(fields: [cityId], references: [id], onDelete: Cascade)

  locale      Locale

  // Translatable fields
  name        String
  slug        String
  description String?  @db.Text

  // SEO
  metaTitle       String?
  metaDescription String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([cityId, locale])
  @@unique([locale, slug])
  @@index([locale])
  @@index([slug])
  @@index([cityId])
}

// ============================================================================
// BOOKINGS & INQUIRIES
// ============================================================================

model Booking {
  id              String   @id @default(cuid())
  tourId          String
  tour            Tour     @relation(fields: [tourId], references: [id])

  // Guest relation (tracks repeat customers)
  guestId         String?
  guest           Guest?   @relation(fields: [guestId], references: [id])

  // Customer info (kept for backward compat & historical accuracy)
  customerName    String
  customerEmail   String
  customerPhone   String?

  // Booking details
  travelDate      DateTime
  numberOfPeople  Int
  totalPrice      Decimal  @db.Decimal(10, 2)

  // Status
  status          String   @default("pending") // pending, confirmed, cancelled
  paymentStatus   String   @default("unpaid") // unpaid, partial, paid

  // Additional info
  specialRequests String?  @db.Text
  notes           String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Staff assignments
  guides          BookingGuide[]
  drivers         BookingDriver[]

  @@index([tourId])
  @@index([guestId])
  @@index([customerEmail])
  @@index([status])
}

// ============================================================================
// GUESTS (Customer tracking for repeat bookings)
// ============================================================================

model Guest {
  id                String    @id @default(cuid())

  // Contact info (email is unique identifier for repeat customer detection)
  email             String    @unique
  name              String
  phone             String?

  // Additional profile info
  country           String?
  preferredLanguage String?   @default("ru") // ru, en, uz

  // Denormalized stats (for fast queries)
  totalBookings     Int       @default(0)
  totalSpent        Decimal   @default(0) @db.Decimal(10, 2)
  lastBookingAt     DateTime?

  // Admin notes
  notes             String?   @db.Text

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  bookings          Booking[]

  @@index([email])
  @@index([name])
  @@index([totalBookings])
  @@index([createdAt])
}

model TourInquiry {
  id              String   @id @default(cuid())
  tourId          String?
  tour            Tour?    @relation(fields: [tourId], references: [id])

  // Contact info
  name            String
  email           String
  phone           String?

  // Inquiry details
  message         String   @db.Text
  travelDate      DateTime?
  travelDateFrom  DateTime?
  travelDateTo    DateTime?
  numberOfPeople  Int?
  budget          Decimal? @db.Decimal(10, 2)

  // Status
  status          String   @default("new") // new, contacted, converted, closed

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tourId])
  @@index([email])
  @@index([status])
  @@index([createdAt])
}

model Contact {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String?
  message   String   @db.Text

  status    String   @default("new") // new, responded, closed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
}

// ============================================================================
// REVIEWS
// ============================================================================

model Review {
  id          String   @id @default(cuid())
  tourId      String
  tour        Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)

  // Reviewer info
  name        String
  email       String
  country     String?

  // Review content
  rating      Int      // 1-5
  title       String?
  comment     String   @db.Text

  // Media
  images      String[]

  // Moderation
  isApproved  Boolean  @default(false)
  isSpam      Boolean  @default(false)
  isFeatured  Boolean  @default(false)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tourId])
  @@index([isApproved])
  @@index([rating])
}

// ============================================================================
// BLOG
// ============================================================================

model BlogPost {
  id              String   @id @default(cuid())

  // Non-translatable fields
  // Media
  featuredImage   String?
  images          String[]

  // Relations
  categoryId      String?
  category        BlogCategory? @relation(fields: [categoryId], references: [id])

  authorId        String
  author          User     @relation(fields: [authorId], references: [id])

  cityId          String?
  city            City?    @relation(fields: [cityId], references: [id])

  // Status
  status          String   @default("draft") // draft, published

  // Stats
  viewCount       Int      @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  translations    BlogPostTranslation[]
  comments        BlogComment[]
  tags            BlogTag[]

  @@index([categoryId])
  @@index([authorId])
  @@index([status])
  @@index([publishedAt])
}

model BlogPostTranslation {
  id              String    @id @default(cuid())
  postId          String
  post            BlogPost  @relation(fields: [postId], references: [id], onDelete: Cascade)

  locale          Locale

  // Translatable fields
  title           String
  slug            String
  excerpt         String?  @db.Text
  content         String   @db.Text

  // SEO
  metaTitle       String?
  metaDescription String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([postId, locale])
  @@unique([locale, slug])
  @@index([locale])
  @@index([slug])
  @@index([postId])
}

model BlogCategory {
  id          String   @id @default(cuid())

  // Non-translatable fields
  image       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  posts        BlogPost[]
  translations BlogCategoryTranslation[]
}

model BlogCategoryTranslation {
  id          String        @id @default(cuid())
  categoryId  String
  category    BlogCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  locale      Locale

  // Translatable fields
  name        String
  slug        String
  description String?  @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([categoryId, locale])
  @@unique([locale, slug])
  @@index([locale])
  @@index([slug])
  @@index([categoryId])
}

model BlogTag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  posts     BlogPost[]

  @@index([slug])
}

model BlogComment {
  id          String   @id @default(cuid())
  postId      String
  post        BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Commenter info
  name        String
  email       String
  website     String?

  // Comment content
  content     String   @db.Text

  // Moderation
  isApproved  Boolean  @default(false)
  isSpam      Boolean  @default(false)

  // Parent comment (for replies)
  parentId    String?
  parent      BlogComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies     BlogComment[] @relation("CommentReplies")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([postId])
  @@index([isApproved])
}

// ============================================================================
// LEADS & CRM
// ============================================================================

model Lead {
  id          String   @id @default(cuid())

  // Contact info
  name        String
  email       String
  phone       String?
  company     String?

  // Lead details
  source      String?  // website, referral, social, etc.
  status      String   @default("new") // new, contacted, qualified, converted, lost
  priority    String   @default("medium") // low, medium, high

  // Notes
  notes       String?  @db.Text

  // Conversion
  convertedToBookingId String?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastContactedAt DateTime?

  @@index([email])
  @@index([status])
  @@index([priority])
}

// ============================================================================
// SUPPLIER COMPANIES (Agencies that employ guides/drivers)
// ============================================================================

model SupplierCompany {
  id              String    @id @default(cuid())
  name            String
  contactPerson   String?
  phone           String?
  email           String?
  address         String?   @db.Text
  notes           String?   @db.Text
  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  drivers         Driver[]
  guides          Guide[]
  contracts       SupplierContract[]

  @@index([name])
  @@index([isActive])
}

// Contract with supplier company (can have multiple over time)
model SupplierContract {
  id              String    @id @default(cuid())
  companyId       String

  // Contract period
  startDate       DateTime
  endDate         DateTime?
  status          String    @default("active") // "active", "expired", "pending", "terminated"

  // Contract details
  terms           String?   @db.Text
  notes           String?   @db.Text

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  company         SupplierCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  rates           ContractRate[]

  @@index([companyId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

// Contract rates (prices defined in the contract)
model ContractRate {
  id              String    @id @default(cuid())
  contractId      String
  supplierType    String    // "driver" or "guide"
  serviceType     String    // "airport_transfer", "half_day", "full_day", "multi_day", "per_km"
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD") // "USD", "UZS"
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  contract        SupplierContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@unique([contractId, supplierType, serviceType])
  @@index([contractId])
  @@index([supplierType])
  @@index([serviceType])
}

// ============================================================================
// GUIDES & DRIVERS (Tour Staff)
// ============================================================================

model Guide {
  id              String    @id @default(cuid())
  name            String
  phone           String?
  email           String?
  languages       String[]  // ["ru", "en", "uz", "de", "fr", etc.]
  notes           String?   @db.Text
  isActive        Boolean   @default(true)

  // Company affiliation (null = freelancer)
  companyId       String?
  company         SupplierCompany? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  bookings        BookingGuide[]
  rates           GuideRate[]

  @@index([isActive])
  @@index([name])
  @@index([companyId])
}

// Individual guide rates (used when guide is freelancer or company has no rate defined)
model GuideRate {
  id              String    @id @default(cuid())
  guideId         String
  serviceType     String    // "half_day", "full_day", "multi_day"
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD")
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  guide           Guide     @relation(fields: [guideId], references: [id], onDelete: Cascade)

  @@unique([guideId, serviceType])
  @@index([guideId])
  @@index([serviceType])
}

model Driver {
  id              String    @id @default(cuid())
  name            String
  phone           String?
  licenseNumber   String?
  languages       String[]
  notes           String?   @db.Text
  isActive        Boolean   @default(true)

  // Company affiliation (null = freelancer)
  companyId       String?
  company         SupplierCompany? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  bookings        BookingDriver[]
  vehicles        DriverVehicle[]
  rates           DriverRate[]

  @@index([isActive])
  @@index([name])
  @@index([companyId])
}

// Individual driver rates (used when driver is freelancer or company has no rate defined)
model DriverRate {
  id              String    @id @default(cuid())
  driverId        String
  serviceType     String    // "airport_transfer", "half_day", "full_day", "multi_day", "per_km"
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD")
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  driver          Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, serviceType])
  @@index([driverId])
  @@index([serviceType])
}

model Vehicle {
  id              String    @id @default(cuid())

  // Vehicle details
  plateNumber     String    @unique
  make            String    // Toyota, Mercedes, etc.
  model           String    // Hiace, Sprinter, etc.
  year            Int?
  color           String?
  capacity        Int?      // Passenger capacity
  type            String    @default("sedan") // sedan, minivan, suv, bus, van

  // Status
  isActive        Boolean   @default(true)
  notes           String?   @db.Text

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  drivers         DriverVehicle[]
  bookings        BookingDriver[]

  @@index([plateNumber])
  @@index([isActive])
}

// Junction table for Many-to-Many: Driver <-> Vehicle
model DriverVehicle {
  id          String    @id @default(cuid())
  driverId    String
  vehicleId   String
  isPrimary   Boolean   @default(false)  // Mark driver's primary vehicle
  assignedAt  DateTime  @default(now())

  driver      Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicle     Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([driverId, vehicleId])
  @@index([driverId])
  @@index([vehicleId])
}

model BookingGuide {
  id        String   @id @default(cuid())
  bookingId String
  guideId   String
  role      String?  // "lead", "assistant"

  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  guide     Guide    @relation(fields: [guideId], references: [id], onDelete: Cascade)

  @@unique([bookingId, guideId])
  @@index([bookingId])
  @@index([guideId])
}

model BookingDriver {
  id        String   @id @default(cuid())
  bookingId String
  driverId  String
  vehicleId String?  // Optional: specific vehicle for this booking

  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  driver    Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  @@unique([bookingId, driverId])
  @@index([bookingId])
  @@index([driverId])
  @@index([vehicleId])
}

// ============================================================================
// USERS & AUTH
// ============================================================================

model User {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  password    String   // Hashed

  role        String   @default("user") // user, admin, super_admin

  // Profile
  avatar      String?
  bio         String?  @db.Text

  // Status
  isActive    Boolean  @default(true)
  emailVerified Boolean @default(false)

  // Password Reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime?

  blogPosts   BlogPost[]

  @@index([email])
  @@index([resetToken])
  @@index([role])
}

// ============================================================================
// SETTINGS
// ============================================================================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  type      String   @default("string") // string, number, boolean, json
  group     String   @default("general")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([group])
}

// ============================================================================
// REDIRECTS (SEO)
// ============================================================================

model Redirect {
  id          String   @id @default(cuid())
  fromPath    String   @unique
  toPath      String
  statusCode  Int      @default(301) // 301 or 302

  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([fromPath])
}
